<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>S.I.S.M.I. - Terminale Operativo</title>
    <style>
        body {
            background-color: #0a0a0a;
            color: #00ff41;
            font-family: 'Courier New', Courier, monospace;
            padding: 20px;
            text-transform: uppercase;
            overflow-x: hidden;
        }

        /* --- UI DI BASE --- */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 90vh; }
        .login-box { border: 2px solid #00ff41; padding: 40px; background: rgba(0, 255, 65, 0.05); text-align: center; max-width: 400px; width: 100%; }
        #main-terminal { display: none; }
        .container { border: 2px solid #00ff41; padding: 20px; box-shadow: 0 0 15px rgba(0, 255, 65, 0.2); background: rgba(0,0,0,0.9); }
        h1, h2 { text-align: center; border-bottom: 1px solid #00ff41; padding-bottom: 10px; }
        .section { margin-bottom: 50px; }
        .admin-panel { background: #111; border: 1px dashed #00ff41; padding: 15px; margin-bottom: 20px; }

        /* --- INPUT & BOTTONI --- */
        input, textarea, select {
            background: #000; border: 1px solid #00ff41; color: #00ff41; padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; font-family: 'Courier New', monospace;
        }
        button { background: #00ff41; color: #000; border: none; padding: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.3s; }
        button:hover { background: #00cc33; box-shadow: 0 0 10px #00ff41; }
        .delete-btn { background: #aa0000; color: #fff; width: auto; padding: 5px 10px; font-size: 11px; margin-top: 5px; border: none; cursor: pointer; }

        /* --- CARDS & FOTO --- */
        .card { border: 1px solid #00ff41; padding: 15px; margin: 15px 0; background: rgba(0, 255, 65, 0.03); }
        .redacted { background-color: #00ff41; color: #00ff41; transition: 0.3s; cursor: help; padding: 0 4px; }
        .redacted:hover { background-color: transparent; }
        .op-photo { max-width: 400px; display: block; margin-top: 10px; border: 1px solid #00ff41; }
        .cit-photo { width: 60px; height: 60px; object-fit: cover; border: 1px solid #00ff41; }

        /* --- TABELLA --- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th, td { border: 1px solid #00ff41; padding: 8px; text-align: left; }
        
        /* Cella Note Modificabile */
        .editable-note { cursor: text; min-width: 200px; transition: 0.2s; }
        .editable-note:focus { background: rgba(0, 255, 65, 0.1); outline: 1px dashed #00ff41; }

        /* --- DEFCON --- */
        #defcon-panel { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        .def-btn { flex: 1; padding: 10px; border: 1px solid #00ff41; color: #00ff41; background: transparent; cursor: pointer; font-size: 10px; }
        .def-btn.active { color: #000; font-weight: bold; }
        .lvl-5.active { background: #00ff41; box-shadow: 0 0 15px #00ff41; }
        .lvl-4.active { background: #aaff00; box-shadow: 0 0 15px #aaff00; }
        .lvl-3.active { background: #ffff00; box-shadow: 0 0 15px #ffff00; }
        .lvl-2.active { background: #ffaa00; box-shadow: 0 0 15px #ffaa00; }
        .lvl-1.active { background: #ff0000; box-shadow: 0 0 15px #ff0000; color: white; }

        /* --- AUDIT LOG --- */
        #audit-container { max-height: 150px; overflow-y: auto; background: #050505; border: 1px solid #444; margin-bottom: 20px; }
        .audit-row { border-bottom: 1px solid #222; padding: 5px; display: flex; gap: 15px; font-size: 11px; }
        .audit-time { color: #888; min-width: 80px; }
        .audit-user { color: #00ff41; min-width: 100px; font-weight: bold; }

        /* --- SYSTEM CONSOLE --- */
        #console-log { background: #000; border: 1px solid #00ff41; height: 120px; overflow-y: hidden; padding: 10px; font-size: 12px; margin-top: 20px; color: #00ff41; opacity: 0.7; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h1>S.I.S.M.I.</h1>
        <p>IDENTIFICAZIONE RICHIESTA</p>
        <input type="text" id="discord-user" placeholder="NOME DISCORD">
        <input type="password" id="role-code" placeholder="ID RUOLO SERVIZI">
        <button onclick="checkAccess()">LOG IN</button>
        <p id="login-error" style="color: red; display: none; margin-top: 15px;">ERRORE: ACCESSO NEGATO</p>
    </div>
</div>

<div id="main-terminal">
    <div class="container">
        <p style="text-align: right;">OPERATORE: <span id="active-user"></span> | STATO: ONLINE</p>
        
        <div class="section">
            <h2>--- LIVELLO DI ALLERTA NAZIONALE ---</h2>
            <div id="defcon-panel">
                <button id="btn-def-5" class="def-btn lvl-5" onclick="setDefcon(5)">DEFCON 5<br>STANDARD</button>
                <button id="btn-def-4" class="def-btn lvl-4" onclick="setDefcon(4)">DEFCON 4<br>INCREMENTATO</button>
                <button id="btn-def-3" class="def-btn lvl-3" onclick="setDefcon(3)">DEFCON 3<br>SQUADRE PRONTE</button>
                <button id="btn-def-2" class="def-btn lvl-2" onclick="setDefcon(2)">DEFCON 2<br>PRE-ALLARME</button>
                <button id="btn-def-1" class="def-btn lvl-1" onclick="setDefcon(1)">DEFCON 1<br>MOBILITAZIONE</button>
            </div>
        </div>

        <div class="section">
            <h2>--- REGISTRO ACCESSI (AUDIT LOG) ---</h2>
            <div id="audit-container">
                <div id="audit-log-body"></div>
            </div>
        </div>

        <div class="section">
            <h2>--- ARCHIVIO DOSSIER ---</h2>
            <div class="admin-panel">
                <input type="text" id="dos-title" placeholder="TITOLO">
                <textarea id="dos-content" placeholder="CONTENUTO (Usa [R]testo[R] per oscurare)"></textarea>
                <button onclick="addDossier()">ARCHIVIA DOSSIER</button>
            </div>
            <div id="dossier-list"></div>
        </div>

        <div class="section">
            <h2>--- SCHEDE CITTADINI ---</h2>
            <div class="admin-panel">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="cit-name" placeholder="NOME">
                    <input type="text" id="cit-photo" placeholder="URL FOTO">
                    <select id="cit-level">
                        <option value="BASSA">BASSA</option>
                        <option value="MEDIA">MEDIA</option>
                        <option value="ALTA">ALTA</option>
                    </select>
                </div>
                <button onclick="addCitizen()">REGISTRA SOGGETTO</button>
            </div>
            <table>
                <thead>
                    <tr><th>FOTO</th><th>SOGGETTO</th><th>MINACCIA</th><th>NOTE OPERATIVE (CLICCA PER SCRIVERE)</th><th>AZIONE</th></tr>
                </thead>
                <tbody id="citizen-table-body"></tbody>
            </table>
        </div>

        <div class="section">
            <h2>--- DATABASE OPERAZIONI ---</h2>
            <div class="admin-panel">
                <input type="text" id="op-title" placeholder="OPERAZIONE">
                <textarea id="op-desc" placeholder="DESCRIZIONE"></textarea>
                <input type="text" id="op-photo" placeholder="URL FOTO">
                <button onclick="addOperation()">INVIA AL DATABASE</button>
            </div>
            <div id="operation-list"></div>
        </div>

        <h2>--- OUTPUT CONSOLE DI SISTEMA ---</h2>
        <div id="console-log"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
    // Configurazione Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDUYP03zV8hW-lewKJIOCZbm1BuRTm_ZOw",
        authDomain: "sismi-db.firebaseapp.com",
        databaseURL: "https://sismi-db-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "sismi-db",
        storageBucket: "sismi-db.firebasestorage.app",
        messagingSenderId: "1030625320459",
        appId: "1:1030625320459:web:57847e28750888f274710e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const CODICE_CORRETTO = "1466703569586618473";
    let currentUser = "";

    function loadData() {
        db.ref('sistema/defcon').on('value', (snapshot) => {
            const level = snapshot.val() || 5;
            updateDefconUI(level);
        });

        db.ref('audit').limitToLast(20).on('value', (snapshot) => {
            const container = document.getElementById('audit-log-body');
            container.innerHTML = "";
            snapshot.forEach((child) => {
                const data = child.val();
                const entry = document.createElement('div');
                entry.className = 'audit-row';
                entry.innerHTML = `<span class="audit-time">[${data.ora}]</span> <span class="audit-user">${data.utente}</span> <span>${data.azione}</span>`;
                container.prepend(entry);
            });
        });

        db.ref('dossier').on('value', (snapshot) => {
            const list = document.getElementById('dossier-list');
            list.innerHTML = "";
            snapshot.forEach((child) => {
                const d = child.val();
                const div = document.createElement('div');
                div.className = 'card';
                let contentHTML = d.contenuto.replace(/\[R\](.*?)\[R\]/g, '<span class="redacted">$1</span>');
                div.innerHTML = `<h3>${d.titolo}</h3><p style="white-space:pre-wrap;">${contentHTML}</p>
                <button class="delete-btn" onclick="deleteEntry('dossier', '${child.key}', 'DOSSIER')">ELIMINA</button>`;
                list.prepend(div);
            });
        });

        // --- SCHEDE CITTADINI CON NOTE MODIFICABILI ---
        db.ref('cittadini').on('value', (snapshot) => {
            const table = document.getElementById('citizen-table-body');
            table.innerHTML = "";
            snapshot.forEach((child) => {
                const c = child.val();
                const key = child.key;
                const row = table.insertRow(0);
                row.innerHTML = `
                    <td><img src="${c.foto}" class="cit-photo"></td>
                    <td><strong>${c.nome}</strong></td>
                    <td>${c.livello}</td>
                    <td class="editable-note" contenteditable="true" onblur="updateCitizenNote('${key}', this.innerText)">${c.note}</td>
                    <td><button class="delete-btn" onclick="deleteEntry('cittadini', '${key}', 'SCHEDA CITTADINO')">X</button></td>
                `;
            });
        });

        db.ref('operazioni').on('value', (snapshot) => {
            const list = document.getElementById('operation-list');
            list.innerHTML = "";
            snapshot.forEach((child) => {
                const op = child.val();
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <h3>OPERAZIONE: ${op.titolo}</h3>
                    <p><strong>DESCRIZIONE:</strong></p>
                    <p style="white-space:pre-wrap;">${op.desc}</p>
                    ${op.foto ? `<img src="${op.foto}" class="op-photo">` : ''}
                    <button class="delete-btn" onclick="deleteEntry('operazioni', '${child.key}', 'OPERAZIONE')">ARCHIVIA</button>
                `;
                list.prepend(div);
            });
        });
    }

    // Salvataggio Note Cittadino
    function updateCitizenNote(key, newText) {
        db.ref('cittadini/' + key).update({
            note: newText
        }).then(() => {
            addAudit("AGGIORNAMENTO NOTE SOGGETTO");
        });
    }

    function addAudit(azione) {
        const now = new Date();
        const time = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0') + ":" + now.getSeconds().toString().padStart(2, '0');
        db.ref('audit').push({ utente: currentUser, azione: azione, ora: time });
    }

    function setDefcon(level) {
        db.ref('sistema/defcon').set(level);
        addAudit(`VARIAZIONE STATO ALLERTA: DEFCON ${level}`);
    }

    function updateDefconUI(level) {
        document.querySelectorAll('.def-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-def-' + level).classList.add('active');
    }

    function addDossier() {
        const title = document.getElementById('dos-title').value;
        const content = document.getElementById('dos-content').value;
        if(!title || !content) return;
        db.ref('dossier').push({ titolo: title, contenuto: content });
        addAudit(`CREAZIONE DOSSIER: ${title}`);
        document.getElementById('dos-title').value = ''; document.getElementById('dos-content').value = '';
    }

    function addCitizen() {
        const name = document.getElementById('cit-name').value;
        const photo = document.getElementById('cit-photo').value || 'https://via.placeholder.com/60?text=S.I.S.';
        const level = document.getElementById('cit-level').value;
        if(!name) return;
        db.ref('cittadini').push({ nome: name, foto: photo, livello: level, note: "IN ATTESA DI AGGIORNAMENTO..." });
        addAudit(`REGISTRAZIONE SOGGETTO: ${name}`);
        document.getElementById('cit-name').value = ''; document.getElementById('cit-photo').value = '';
    }

    function addOperation() {
        const title = document.getElementById('op-title').value;
        const desc = document.getElementById('op-desc').value;
        const photo = document.getElementById('op-photo').value;
        if(!title) return;
        db.ref('operazioni').push({ titolo: title, desc: desc, foto: photo });
        addAudit(`INVIO DATI OPERATIVI: ${title}`);
        document.getElementById('op-title').value = ''; document.getElementById('op-desc').value = ''; document.getElementById('op-photo').value = '';
    }

    function deleteEntry(path, key, tipo) {
        if(confirm("CONFERMARE ELIMINAZIONE DEFINITIVA?")) {
            db.ref(path + '/' + key).remove();
            addAudit(`ELIMINAZIONE ${tipo}`);
        }
    }

    function checkAccess() {
        const user = document.getElementById('discord-user').value;
        const code = document.getElementById('role-code').value.trim();
        if (code === CODICE_CORRETTO && user !== "") {
            currentUser = user.toUpperCase();
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-terminal').style.display = 'block';
            document.getElementById('active-user').innerText = currentUser;
            loadData();
            addAudit("LOG-IN: ACCESSO EFFETTUATO AL TERMINALE");
            startSystemConsole(); 
        } else {
            document.getElementById('login-error').style.display = 'block';
            setTimeout(() => { document.getElementById('login-error').style.display = 'none'; }, 3000);
        }
    }

    function startSystemConsole() {
        const logs = [
            "[INFO] Stabilizzazione tunnel VPN...", "[SYSTEM] Controllo integritÃ  database...",
            "[WARN] Tentativo di ping esterno rilevato.", "[INFO] Crittografia AES-256 attiva.",
            "[SYSTEM] Sincronizzazione orologio atomico.", "[INFO] Bypass firewall completato.",
            "[DEBUG] Buffer overflow evitato.", "[INFO] Messaggio criptato ricevuto."
        ];
        setInterval(() => {
            const consoleBox = document.getElementById('console-log');
            const logEntry = document.createElement('div');
            logEntry.innerText = "> " + logs[Math.floor(Math.random() * logs.length)];
            consoleBox.appendChild(logEntry);
            consoleBox.scrollTop = consoleBox.scrollHeight;
            if (consoleBox.childNodes.length > 7) consoleBox.removeChild(consoleBox.firstChild);
        }, 3000);
    }
</script>

</body>
</html>

